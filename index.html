<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familien Bro - Ukesmeny</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #fafaf9; color: #44403c; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-only { display: block !important; }
        }
        
        .clickable-card:active { transform: scale(0.98); }
        .lunch-card:hover { filter: brightness(0.95); }
        
        .step-checked {
            text-decoration: line-through;
            color: #a8a29e;
            transition: all 0.3s ease;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .timer-finished {
            animation: pulse-red 2s infinite;
            background-color: #7f1d1d;
            border-color: #ef4444;
        }
    </style>
</head>
<body>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- LYDEFFEKT (Rolig alarm) ---
        const playCalmAlarm = () => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const now = ctx.currentTime;

            // En rolig C-dur akkord (C4, E4, G4) arpeggio
            const notes = [261.63, 329.63, 392.00]; 
            
            notes.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = 'sine'; // Sine waves are calmer
                osc.frequency.setValueAtTime(freq, now + (i * 0.2)); // Staggered start
                
                gain.gain.setValueAtTime(0, now + (i * 0.2));
                gain.gain.linearRampToValueAtTime(0.3, now + (i * 0.2) + 0.1); // Fade in
                gain.gain.exponentialRampToValueAtTime(0.01, now + (i * 0.2) + 1.5); // Slow fade out

                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start(now + (i * 0.2));
                osc.stop(now + (i * 0.2) + 2);
            });
        };

        const Icon = ({ name, className }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]); 
            return <i data-lucide={name} className={className}></i>;
        };

        // --- TAG SEARCH INPUT COMPONENT ---
        const TagSearchInput = ({ tags, setTags, inputValue, setInputValue, placeholder }) => {
            const handleKeyDown = (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const trimmedInput = inputValue.trim();
                    if (trimmedInput && !tags.includes(trimmedInput)) {
                        setTags([...tags, trimmedInput]);
                        setInputValue('');
                    }
                } else if (e.key === 'Backspace' && !inputValue && tags.length > 0) {
                    setTags(tags.slice(0, -1));
                }
            };

            const removeTag = (tagToRemove) => {
                setTags(tags.filter(tag => tag !== tagToRemove));
            };

            return (
                <div className="flex flex-wrap items-center gap-2 w-full p-2 border border-stone-200 rounded-xl bg-white shadow-sm focus-within:ring-2 focus-within:ring-lime-500 focus-within:border-lime-500">
                    <div className="pl-2 pointer-events-none text-stone-400">
                        <Icon name="search" className="h-5 w-5" />
                    </div>
                    
                    {tags.map((tag, index) => (
                        <span key={index} className="flex items-center gap-1 bg-lime-100 text-lime-800 px-2 py-1 rounded-md text-sm font-medium animate-fade-in">
                            {tag}
                            <button 
                                onClick={() => removeTag(tag)}
                                className="hover:bg-lime-200 rounded-full p-0.5 transition-colors"
                            >
                                <Icon name="x" className="w-3 h-3" />
                            </button>
                        </span>
                    ))}
                    
                    <input 
                        type="text" 
                        className="flex-grow min-w-[150px] outline-none text-stone-700 placeholder-stone-400 bg-transparent py-1"
                        placeholder={tags.length === 0 ? placeholder : ""}
                        value={inputValue}
                        onChange={(e) => setInputValue(e.target.value)}
                        onKeyDown={handleKeyDown}
                    />
                </div>
            );
        };

        // --- FLERE TIMERE COMPONENT (Med Lyd-Loop) ---
        const FloatingTimerList = ({ activeTimers, setActiveTimers }) => {
            const alarmIntervalRef = useRef(null);
            
            // Sjekk om noen timere ringer (finished men ikke acknowledged)
            const isRinging = activeTimers.some(t => t.finished && !t.acknowledged);

            // Timer nedtelling logic
            useEffect(() => {
                const interval = setInterval(() => {
                    setActiveTimers(prevTimers => prevTimers.map(timer => {
                        if (!timer.active || timer.finished) return timer;
                        const newTime = timer.timeRemaining - 1;
                        if (newTime <= 0) {
                            return { ...timer, timeRemaining: 0, active: false, finished: true, acknowledged: false };
                        }
                        return { ...timer, timeRemaining: newTime };
                    }));
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            // ALARM LYD LOOP LOGIC
            useEffect(() => {
                if (isRinging) {
                    // Start loop hvis den ikke g친r
                    if (!alarmIntervalRef.current) {
                        playCalmAlarm(); // Spill med en gang
                        alarmIntervalRef.current = setInterval(() => {
                            playCalmAlarm();
                        }, 4000); // Gjenta hvert 4. sekund
                    }
                } else {
                    // Stopp loop hvis ingen ringer
                    if (alarmIntervalRef.current) {
                        clearInterval(alarmIntervalRef.current);
                        alarmIntervalRef.current = null;
                    }
                }
                
                // Cleanup ved unmount
                return () => {
                    if (alarmIntervalRef.current) clearInterval(alarmIntervalRef.current);
                };
            }, [isRinging]);

            if (activeTimers.length === 0) return null;

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            const removeTimer = (id) => {
                setActiveTimers(prev => prev.filter(t => t.id !== id));
            };

            const toggleTimer = (id) => {
                setActiveTimers(prev => prev.map(t => t.id === id ? {...t, active: !t.active} : t));
            };

            const acknowledgeAlarm = (id) => {
                // Stopper lyden for denne timeren ved 친 sette acknowledged = true
                setActiveTimers(prev => prev.map(t => t.id === id ? {...t, acknowledged: true} : t));
            };

            return (
                <div className="fixed bottom-4 right-4 flex flex-col gap-2 z-50 animate-fade-in items-end">
                    {activeTimers.map(timer => (
                        <div key={timer.id} className={`text-white p-3 rounded-xl shadow-lg flex items-center gap-3 border border-stone-700 min-w-[220px] justify-between transition-all duration-300 ${timer.finished && !timer.acknowledged ? 'timer-finished scale-105' : 'bg-stone-900'}`}>
                            <div className="flex flex-col">
                                <span className="text-[10px] text-stone-400 uppercase tracking-widest truncate max-w-[120px]">{timer.label}</span>
                                <span className="text-xl font-mono font-bold text-lime-400">
                                    {timer.finished ? "Tiden er ute!" : formatTime(timer.timeRemaining)}
                                </span>
                            </div>
                            
                            <div className="flex gap-1">
                                {timer.finished && !timer.acknowledged ? (
                                    <button 
                                        onClick={() => acknowledgeAlarm(timer.id)} 
                                        className="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white text-xs font-bold rounded-full animate-pulse"
                                    >
                                        Skru av
                                    </button>
                                ) : (
                                    <>
                                        {!timer.finished && (
                                            <button onClick={() => toggleTimer(timer.id)} className="p-1.5 bg-stone-700 rounded-full hover:bg-stone-600">
                                                <Icon name={timer.active ? "pause" : "play"} className="w-4 h-4" />
                                            </button>
                                        )}
                                        <button onClick={() => removeTimer(timer.id)} className="p-1.5 bg-stone-700 rounded-full hover:bg-red-900/50 hover:text-red-400">
                                            <Icon name="x" className="w-4 h-4" />
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- DATA (Uendret) ---
        const week1Data = [
            {
                day: "Mandag", theme: "Fet fisk & Omega-3", lunchKid: "Fullkornslefse med sn칮frisk & r칮kelaks", lunchAdult: "Rester av s칮ndagsmiddag (eller salat)", dinner: "Ovnsbakt laks med rotgr칮nnsaker & tzatziki", iconName: "fish", color: "text-sky-600", image: "https://images.unsplash.com/photo-1485921325833-c519f76c4927?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: "Ovnsbakt laks & rotgr칮nt", image: "https://images.unsplash.com/photo-1485921325833-c519f76c4927?q=80&w=800&auto=format&fit=crop", desc: "Alt i 칠n form - minimalt med oppvask!", servings: 4, time: "30 min", timers: [{ label: "Bak gr칮nnsaker", minutes: 10 }, { label: "Bak laksen ferdig", minutes: 12 }], nutrition: { calories: "520", protein: "38g", fat: "28g", carbs: "25g" }, ingredients: ["4 laksefileter", "2 s칮tpoteter", "2 gulr칮tter", "1 brokkoli", "Olivenolje", "Sitronpepper", "Tzatziki eller r칮mme"], steps: ["Sett ovnen p친 200 grader.", "Kutt gr칮nnsaker i biter og legg i en ildfast form.", "Hell over litt olje og krydder. Bak i 10 min.", "Legg laksestykkene opp친 gr칮nnsakene.", "Bak videre i ca 12-15 min til laksen er ferdig.", "Server med en klatt tzatziki."] },
                    lunchKid: { title: "Laksewraps", image: "https://images.unsplash.com/photo-1626700051175-6818013e1d4f?q=80&w=800&auto=format&fit=crop", desc: "Enkel m친te 친 f친 i barna fisk p친.", servings: 1, time: "5 min", nutrition: { calories: "280", protein: "14g", fat: "15g", carbs: "22g" }, ingredients: ["1 fullkornslefse/tortilla", "1 ss Sn칮frisk", "2 skiver r칮kelaks", "Litt spinat"], steps: ["Sm칮r lefsen med kremost.", "Legg p친 laks og gr칮nt.", "Rull tett sammen."] },
                    lunchAdult: null 
                }
            },
            {
                day: "Tirsdag", theme: "Kj칮ttfri & Tarmhelse", lunchKid: "Grovbr칮d med hummus, paprika & druer", lunchAdult: "Rester av Laks (fra mandag)", dinner: "Kremet linsegryte med kokosmelk & nanbr칮d", iconName: "leaf", color: "text-lime-700", image: "https://images.unsplash.com/photo-1547592180-85f173990554?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: "Kremet linsegryte", image: "https://images.unsplash.com/photo-1547592180-85f173990554?q=80&w=800&auto=format&fit=crop", desc: "En varmende gryte full av fiber og gode smaker.", servings: 4, time: "20 min", timers: [{ label: "Koke linser", minutes: 15 }], nutrition: { calories: "410", protein: "19g", fat: "14g", carbs: "48g" }, ingredients: ["2 dl r칮de linser (t칮rre)", "1 boks kokosmelk", "1 boks hakkede tomater", "1 l칮k + 2 fedd hvitl칮k", "1 pose spinat", "1 ts ingef칝r", "Nanbr칮d til servering"], steps: ["Fres hakket l칮k, hvitl칮k og ingef칝r i litt olje.", "Tilsett linser, tomater og kokosmelk. Kok opp.", "La sm친koke i 15 min til linsene er m칮re.", "R칮r inn spinaten helt til slutt s친 den faller sammen.", "Smak til med salt/pepper. Server med nanbr칮d."] },
                    lunchKid: { title: "Hummus-skiver & gr칮nt", image: "https://images.unsplash.com/photo-1621532982823-3b1a26d7f6c3?q=80&w=800&auto=format&fit=crop", desc: "N칝ringsrik lunsj som holder blodsukkeret stabilt.", servings: 1, time: "5 min", nutrition: { calories: "320", protein: "11g", fat: "13g", carbs: "38g" }, ingredients: ["2 skiver grovbr칮d", "3 ss hummus (kj칮pt eller hjemmelaget)", "Paprikastaver", "En liten neve druer"], steps: ["Sm칮r et godt lag hummus p친 br칮dskivene.", "Kutt paprika i staver som er lette 친 spise.", "Legg ved druer i matboksen."] },
                    lunchAdult: { title: "Lakse-salat (rester)", image: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=800", desc: "Bruk restene fra mandag!", servings: 1, time: "5 min", nutrition: { calories: "400", protein: "30g", fat: "20g", carbs: "15g" }, ingredients: ["Kald laks", "Ruccola/Spinat", "Agurk", "Dressing"], steps: ["Bland laks og gr칮nnsaker."] }
                }
            },
            {
                day: "Onsdag", theme: "Kylling & Fullkorn", lunchKid: "Havrelapper med brunost & gulrot", lunchAdult: "Rester av Linsegryte", dinner: "Kyllingpanne med pesto & fullkornspasta", iconName: "utensils-crossed", color: "text-orange-600", image: "https://images.unsplash.com/photo-1473093295043-cdd812d0e601?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: "Kyllingpanne med pesto", image: "https://images.unsplash.com/photo-1473093295043-cdd812d0e601?q=80&w=800&auto=format&fit=crop", desc: "Rask hverdagsmiddag som barna elsker.", servings: 4, time: "20 min", timers: [{ label: "Koke pasta", minutes: 10 }, { label: "Surre kylling & tomat", minutes: 2 }], nutrition: { calories: "580", protein: "42g", fat: "22g", carbs: "48g" }, ingredients: ["400g kyllingfilet", "300g fullkornspasta", "1 glass gr칮nn pesto", "1 pk cherrytomater", "Parmesan"], steps: ["Kok pasta.", "Stek kyllingbiter gylne.", "Del tomatene i to og la dem surre med kyllingen.", "Bland ferdig pasta med pesto, kylling og tomater."] },
                    lunchKid: { title: "Grove havrelapper", image: "https://images.unsplash.com/photo-1575853121743-60c24f0a7502?q=80&w=800&auto=format&fit=crop", desc: "Lag r칮ren kvelden f칮r for superrask steking om morgenen.", servings: 1, time: "15 min", nutrition: { calories: "220", protein: "9g", fat: "7g", carbs: "28g" }, ingredients: ["1 egg", "1 dl havregryn", "0.5 dl melk", "0.5 ts bakepulver"], steps: ["Bland ingrediensene og la svelle.", "Stek sm친 lapper i pannen."] },
                    lunchAdult: { title: "Linsegryte (rester)", image: "https://images.unsplash.com/photo-1547592180-85f173990554?q=80&w=800", desc: "Varm opp i mikroen.", servings: 1, time: "2 min", nutrition: { calories: "410", protein: "19g", fat: "14g", carbs: "48g" }, ingredients: ["Linsegryte", "Nanbr칮d"], steps: ["Varm opp."] }
                }
            },
            {
                day: "Torsdag", theme: "Suppe & Raske l칮sninger", lunchKid: "Grovbr칮d med leverpostei & r칮dbeter", lunchAdult: "Salat med ruccola, avokado & kikerter", dinner: "Hjemmelaget tomatsuppe med egg (og linser!)", iconName: "chef-hat", color: "text-red-500", image: "https://images.unsplash.com/photo-1576098762557-4f0165780287?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: 'Tomatsuppe med "skjulte" linser', image: "https://images.unsplash.com/photo-1576098762557-4f0165780287?q=80&w=800&auto=format&fit=crop", desc: 'En superhelt-suppe som lurer inn masse n칝ring!', servings: 4, time: "25 min", timers: [{ label: "Koke suppe", minutes: 20 }, { label: "Koke egg", minutes: 9 }], nutrition: { calories: "340", protein: "16g", fat: "12g", carbs: "36g" }, ingredients: ["1 ss olivenolje", "1 l칮k & 2 fedd hvitl칮k", "2 gulr칮tter", "1 dl r칮de linser", "2 bokser hakkede tomater", "8 dl kraft"], steps: ["Stek l칮k, hvitl칮k og gulrot.", "Tilsett tomater, kraft og linser. Kok opp.", "La sm친koke i 15-20 min.", "Kj칮r glatt med stavmikser. Server med egg."] },
                    lunchKid: { title: "Leverpostei-skive", image: "https://images.unsplash.com/photo-1603048588665-791ca8aea617?q=80&w=800&auto=format&fit=crop", desc: "Klassikeren med masse jern.", servings: 1, time: "3 min", nutrition: { calories: "260", protein: "11g", fat: "11g", carbs: "26g" }, ingredients: ["2 skiver grovbr칮d", "Leverpostei", "Sylteagurk/r칮dbeter"], steps: ["Sm칮r br칮det og pynt med gr칮nt."] },
                    lunchAdult: { title: "Gr칮nn kikertsalat", image: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=800&auto=format&fit=crop", desc: "Enkel, mettende og vegansk.", servings: 1, time: "5 min", nutrition: { calories: "360", protein: "13g", fat: "22g", carbs: "24g" }, ingredients: ["Ruccola", "1/2 avokado", "1/2 boks kikerter", "Gresskarkjerner", "Olivenolje"], steps: ["Bland alt sammen i en boks.", "Hell over litt olje."] }
                }
            },
            {
                day: "Fredag", theme: "Fisketaco (Middelhavs-vri)", lunchKid: "Pastasalat med mais & eple", lunchAdult: "Omelett med spinat & fetaost", dinner: "Fisketaco med torsk & mangosalsa", iconName: "fish", color: "text-purple-600", image: "https://images.unsplash.com/photo-1599974579688-8dbdd335c77f?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: "Fisketaco med torsk", image: "https://images.unsplash.com/photo-1599974579688-8dbdd335c77f?q=80&w=800&auto=format&fit=crop", desc: "En frisk og sunn start p친 helgen.", servings: 4, time: "25 min", nutrition: { calories: "480", protein: "32g", fat: "16g", carbs: "46g" }, ingredients: ["500g torskefilet", "Tacokrydder", "Tortillas", "1 mango", "1/2 r칮dk친l", "R칮mme", "Lime"], steps: ["Del torsken i terninger og stek med tacokrydder.", "Kutt opp mango og r칮dk친l.", "Varm tortillaene.", "Server som taco."] },
                    lunchKid: { title: "Pastasalat", image: "https://images.unsplash.com/photo-1623428187969-5da2dcea5ebf?q=80&w=800&auto=format&fit=crop", desc: "Perfekt m친te 친 bruke opp rester av pasta.", servings: 1, time: "5 min", nutrition: { calories: "290", protein: "9g", fat: "9g", carbs: "40g" }, ingredients: ["Kokt pasta", "Mais", "Eple", "Agurk"], steps: ["Bland alt sammen."] },
                    lunchAdult: { title: "Spinatomelett", image: "https://images.unsplash.com/photo-1510693206972-df098062cb71?q=80&w=800&auto=format&fit=crop", desc: "Proteinrik lunsj.", servings: 1, time: "10 min", nutrition: { calories: "310", protein: "21g", fat: "24g", carbs: "4g" }, ingredients: ["2 egg", "Spinat", "Fetaost"], steps: ["Stek spinat raskt.", "Hell over eggene og dryss med feta."] }
                }
            }
        ];

        const week2Data = [
            {
                day: "Mandag", theme: "Fisk & Ingef칝r-kick", lunchKid: "Matmuffins med ost og skinke", lunchAdult: "Caprese-salat med tomat & mozzarella", dinner: "Laks med ingef칝r, soya & sesam", iconName: "fish", color: "text-rose-600", image: "https://images.unsplash.com/photo-1543826173-70651703c5a4?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: "Ingef칝r-glasert Laks", image: "https://images.unsplash.com/photo-1543826173-70651703c5a4?q=80&w=800&auto=format&fit=crop", desc: "Smaksrik fiskemiddag som lager seg selv i ovnen.", servings: 4, time: "20 min", timers: [{ label: "Bake laks", minutes: 15 }], nutrition: { calories: "550", protein: "38g", fat: "30g", carbs: "22g" }, ingredients: ["4 laksefileter", "3 ss soyasaus", "1 ss honning", "1 ss revet ingef칝r", "Sesamfr칮", "Brokkoli", "Ris/Nudler"], steps: ["Bland soya, honning og ingef칝r.", "Legg laksen i form og hell sausen over.", "Bak i ovnen p친 200 grader i 12-15 min.", "Str칮 over sesamfr칮 ved servering."] },
                    lunchKid: { title: "Matmuffins", image: "https://images.unsplash.com/photo-1620063251786-b4d618d35091?q=80&w=800", desc: "Lag opp p친 s칮ndag - holder hele uken!", servings: 12, time: "30 min", timers: [{ label: "Steke muffins", minutes: 18 }], nutrition: { calories: "180", protein: "8g", fat: "10g", carbs: "15g" }, ingredients: ["3 egg", "3 dl mel", "1 ts bakepulver", "100g skinke", "100g revet ost", "1 dl melk"], steps: ["Bland egg og melk.", "R칮r inn det t칮rre og fyllet.", "Stek i muffinsformer p친 200 grader i ca 15-20 min."] },
                    lunchAdult: { title: "Caprese Salat", image: "https://images.unsplash.com/photo-1529312266912-b33cf6227e2f?q=80&w=800&auto=format&fit=crop", desc: "Enkelt, friskt og italiensk.", servings: 1, time: "5 min", nutrition: { calories: "320", protein: "18g", fat: "24g", carbs: "6g" }, ingredients: ["1 mozzarella-ball", "2 tomater", "Fersk basilikum", "Olivenolje", "Balsamico"], steps: ["Skj칝r tomat og mozzarella i skiver.", "Legg lagvis p친 tallerken.", "Topp med basilikum, olje og litt salt."] }
                }
            },
            {
                day: "Tirsdag", theme: "Gresk Aften", lunchKid: "Fullkornspasta med gr칮nn pesto & erter", lunchAdult: "Rester av Ingef칝r-laks", dinner: "Kylling Souvlaki med Tzatziki", iconName: "utensils-crossed", color: "text-sky-700", image: "https://images.unsplash.com/photo-1532592309856-1c32483864b4?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: "Kylling Souvlaki", image: "https://images.unsplash.com/photo-1532592309856-1c32483864b4?q=80&w=800&auto=format&fit=crop", desc: "Greske smaker som barna liker.", servings: 4, time: "25 min", nutrition: { calories: "450", protein: "42g", fat: "18g", carbs: "30g" }, ingredients: ["400g kyllingfilet", "Oregano", "Sitron", "Hvitl칮k", "Tzatziki", "Pita/Lefser", "Agurk & Tomat"], steps: ["Mariner kyllingbiter i olje, sitron og oregano.", "Stek i panne eller p친 spyd i ovnen.", "Server i pita med tzatziki og salat."] },
                    lunchKid: { title: "Pesto-pasta", image: "https://images.unsplash.com/photo-1473093295043-cdd812d0e601?q=80&w=800", desc: "Kald pasta er super matpakke-mat.", servings: 1, time: "5 min", nutrition: { calories: "350", protein: "10g", fat: "12g", carbs: "50g" }, ingredients: ["Kokt pasta", "1 ss pesto", "Frosne erter (tiner i boksen)"], steps: ["Bland pasta med pesto og erter.", "Legg gjerne ved noen cherrytomater."] },
                    lunchAdult: { title: "Laks & Brokkoli (rester)", image: "https://images.unsplash.com/photo-1543826173-70651703c5a4?q=80&w=800", desc: "Smakene setter seg enda bedre til i dag.", servings: 1, time: "2 min", nutrition: { calories: "550", protein: "38g", fat: "30g", carbs: "22g" }, ingredients: ["Laks", "Ris", "Brokkoli"], steps: ["Varm opp."] }
                }
            },
            {
                day: "Onsdag", theme: "Suppe-onsdag", lunchKid: "Yoghurt med granola & b칝r + knekkebr칮d", lunchAdult: "Kylling-wrap (rester fra tirsdag)", dinner: "Hvit Minestronesuppe med b칮nner", iconName: "chef-hat", color: "text-emerald-600", image: "https://images.unsplash.com/photo-1620916566398-39f1143ab7be?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: "Hvit Minestrone", image: "https://images.unsplash.com/photo-1620916566398-39f1143ab7be?q=80&w=800&auto=format&fit=crop", desc: "En lys og lett suppe full av gr칮nnsaker.", servings: 4, time: "20 min", timers: [{ label: "Koke poteter m칮re", minutes: 15 }], nutrition: { calories: "320", protein: "16g", fat: "8g", carbs: "42g" }, ingredients: ["1 boks hvite b칮nner", "Poteter i terninger", "Gulrot", "Stangselleri", "Gr칮nnsakskraft", "Litt pasta/makaroni"], steps: ["Kutt alle gr칮nnsaker i sm친 terninger.", "Fres i gryta.", "Hell p친 kraft og kok til potetene er m칮re.", "Ha i b칮nner og pasta mot slutten."] },
                    lunchKid: { title: "Yoghurt-lunsj", image: "https://images.unsplash.com/photo-1488477181946-6428a0291777?q=80&w=800", desc: "Friskt og godt.", servings: 1, time: "2 min", nutrition: { calories: "300", protein: "15g", fat: "8g", carbs: "40g" }, ingredients: ["Naturell yoghurt", "Granola", "B칝r", "1 knekkebr칮d med ost"], steps: ["Ha yoghurt i tett boks, granola ved siden av."] },
                    lunchAdult: { title: "Kylling i pita (rester)", image: "https://images.unsplash.com/photo-1532592309856-1c32483864b4?q=80&w=800", desc: "Kald souvlaki er digg!", servings: 1, time: "2 min", nutrition: { calories: "450", protein: "42g", fat: "18g", carbs: "30g" }, ingredients: ["Kylling", "Pita", "Tzatziki"], steps: ["Pakk inn restene."] }
                }
            },
            {
                day: "Torsdag", theme: "Anti-inflammatorisk & Gurkemeie", lunchKid: "Fiskekaker i lompe/grovbr칮d", lunchAdult: "Tunfisksalat med egg & r칮dl칮k", dinner: "Gyllen kikertgryte med gurkemeie", iconName: "leaf", color: "text-amber-600", image: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: "Gyllen kikertgryte", image: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=800&auto=format&fit=crop", desc: "En sunn middag med kraften fra gurkemeie.", servings: 4, time: "25 min", timers: [{ label: "Sm친koke", minutes: 15 }], nutrition: { calories: "380", protein: "14g", fat: "12g", carbs: "45g" }, ingredients: ["2 bokser kikerter", "1 ss gurkemeie", "1 boks kokosmelk", "1 l칮k", "Ingef칝r (fersk)", "Spinat", "Ris til servering"], steps: ["Fres l칮k, hvitl칮k og revet ingef칝r i olje.", "Tilsett gurkemeie og la det frese litt.", "Ha i kikerter og kokosmelk. La sm친koke i 15 min.", "Vend inn spinat f칮r servering."] },
                    lunchKid: { title: "Fiskekake-lunsj", image: "https://images.unsplash.com/photo-1565557623262-b51c2513a641?q=80&w=800", desc: "Kald fiskekake er bedre enn du tror!", servings: 1, time: "1 min", nutrition: { calories: "250", protein: "15g", fat: "10g", carbs: "25g" }, ingredients: ["1-2 fiskekaker", "1 lompe eller br칮dskive", "Ketchup?"], steps: ["Pakk fiskekaken i lompe eller ha p친 br칮d."] },
                    lunchAdult: { title: "Tunfisksalat", image: "https://images.unsplash.com/photo-1543340904-991f3751a30f?q=80&w=800", desc: "Proteinbombe.", servings: 1, time: "10 min", nutrition: { calories: "380", protein: "40g", fat: "18g", carbs: "10g" }, ingredients: ["1 boks tunfisk", "1 kokt egg", "R칮dl칮k", "Salatblader", "Litt majones/r칮mme"], steps: ["Bland tunfisk med hakket r칮dl칮k og litt dressing.", "Server p친 en seng av salat med eggb친ter."] }
                }
            },
            {
                day: "Fredag", theme: "Middelhavs-Taco", lunchKid: "Polarbr칮d-pizza (kald)", lunchAdult: "Omelett med tomat & basilikum", dinner: "Halloumi-tacos med mangosalsa", iconName: "smile", color: "text-orange-500", image: "https://images.unsplash.com/photo-1551504734-5ee1c4a1479b?q=80&w=800&auto=format&fit=crop",
                recipes: {
                    dinner: { title: "Halloumi-tacos", image: "https://images.unsplash.com/photo-1551504734-5ee1c4a1479b?q=80&w=800&auto=format&fit=crop", desc: "En morsom vri p친 fredagstacoen.", servings: 4, time: "20 min", nutrition: { calories: "560", protein: "24g", fat: "38g", carbs: "34g" }, ingredients: ["1 pk Halloumi-ost", "Sm친 tortillas", "1 mango", "Avokado/Guacamole", "Chili", "Lime"], steps: ["Kutt mango og avokado i terninger (salsa).", "Stek skiver av halloumi i pannen til gylne.", "Server i varme tortillas med salsa og lime."] },
                    lunchKid: { title: "Polarbr칮d-pizza", image: "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?q=80&w=800", desc: "Lages kvelden f칮r eller om morgenen.", servings: 1, time: "10 min", nutrition: { calories: "320", protein: "14g", fat: "12g", carbs: "35g" }, ingredients: ["Polarbr칮d", "Tomatpur칠", "Ost", "Skinke"], steps: ["Sm칮r tomatpur칠 p친 polarbr칮d.", "Ha p친 ost og skinke.", "Gratiner i ovnen til osten smelter. Avkj칮l."] },
                    lunchAdult: { title: "Tomat-omelett", image: "https://images.unsplash.com/photo-1510693206972-df098062cb71?q=80&w=800", desc: "Enkel proteinlunsj.", servings: 1, time: "10 min", nutrition: { calories: "300", protein: "20g", fat: "22g", carbs: "5g" }, ingredients: ["2 egg", "Tomater", "Basilikum", "Parmesan"], steps: ["Pisk egg.", "Stek i panne med tomater.", "Topp med urter."] }
                }
            }
        ];

        const shoppingListWeek1 = {
            "Frukt & Gr칮nt": ["Kiwi", "Pasjonsfrukt", "Agurk (1)", "Paprika (2)", "Spinat", "Cherrytomater", "S칮tpotet (2)", "Gulr칮tter", "Brokkoli", "Ruccola", "Avokado", "R칮dk친l", "L칮k & Hvitl칮k", "Ingef칝r", "Chili"],
            "Kj칮l & Meieri": ["R칮kelaks", "Makrell i tomat", "Leverpostei", "Brunost", "Sn칮frisk", "Fetaost", "Egg (12)", "Melk", "Yoghurt", "R칮mme", "Sm칮r"],
            "T칮rrvarer": ["Hakkede tomater (4)", "Kikerter", "Kokosmelk", "Mais", "R칮de linser", "Quinoa", "Ris", "Pasta", "Havregryn", "Br칮d", "Lefser", "Nanbr칮d", "N칮tter", "Pesto", "Buljong"],
            "Fisk & Kj칮tt": ["Laksefileter (4)", "Torskefilet", "Kyllingfilet"]
        };

        const shoppingListWeek2 = {
            "Frukt & Gr칮nt": ["Kiwi", "Pasjonsfrukt", "L칮k & Hvitl칮k", "Ingef칝r (fersk)", "Spinat", "Tomater (4-5)", "Agurk", "Avokado (2)", "Mango (2)", "Poteter", "Gulrot", "Stangselleri", "Fersk Basilikum", "Sitron & Lime"],
            "Kj칮l & Meieri": ["Mozzarella (1)", "Halloumi (1 pk)", "Tzatziki (eller yoghurt)", "Egg (12)", "Melk", "Ost (revet)", "Skinke", "Sm칮r"],
            "T칮rrvarer": ["Kikerter (2 bokser)", "Kokosmelk (1 boks)", "Soyasaus", "Sesamfr칮", "Honning", "Hvite b칮nner (1 boks)", "Ris/Nudler", "Pita/Lefser", "Tortillas (sm친)", "Tunfisk (boks)", "Granola", "Pasta", "Pesto", "Knekkebr칮d"],
            "Fisk & Kj칮tt": ["Laksefileter (4)", "Kyllingfilet (400g)", "Fiskekaker"]
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('menu');
            const [currentWeek, setCurrentWeek] = useState(1);
            const [checkedItems, setCheckedItems] = useState({});
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            // Recipe & App States
            const [currentRecipe, setCurrentRecipe] = useState(null);
            const [recipeServings, setRecipeServings] = useState(4);
            const [completedSteps, setCompletedSteps] = useState(new Set());
            const [ratings, setRatings] = useState({});
            
            // Search States
            const [searchTags, setSearchTags] = useState([]);
            const [searchInputValue, setSearchInputValue] = useState("");
            
            // Multiple Timers State
            const [activeTimers, setActiveTimers] = useState([]);

            // Helper: Collect all recipes flat
            const allRecipes = useMemo(() => {
                const recipes = [];
                const add = (rec, type, day, week) => {
                    if(rec) recipes.push({...rec, type, day, week});
                };
                [...week1Data].forEach(d => {
                    add(d.recipes.dinner, 'Middag', d.day, 1);
                    add(d.recipes.lunchKid, 'Lunsj (Barn)', d.day, 1);
                    add(d.recipes.lunchAdult, 'Lunsj (Voksen)', d.day, 1);
                });
                [...week2Data].forEach(d => {
                    add(d.recipes.dinner, 'Middag', d.day, 2);
                    add(d.recipes.lunchKid, 'Lunsj (Barn)', d.day, 2);
                    add(d.recipes.lunchAdult, 'Lunsj (Voksen)', d.day, 2);
                });
                return recipes;
            }, []);

            useEffect(() => {
                try {
                    const savedList = localStorage.getItem(`familienBro-handleliste-uke${currentWeek}`);
                    if (savedList) setCheckedItems(JSON.parse(savedList));
                    const savedRatings = localStorage.getItem('familienBro-ratings');
                    if (savedRatings) setRatings(JSON.parse(savedRatings));
                } catch (e) { console.error(e); }
            }, [currentWeek]);

            const activeMenuData = currentWeek === 1 ? week1Data : week2Data;
            const activeShoppingList = currentWeek === 1 ? shoppingListWeek1 : shoppingListWeek2;

            // Search logic (multi-tag)
            const filteredAllRecipes = allRecipes.filter(r => {
                if (searchTags.length === 0 && !searchInputValue) return true;
                
                const terms = [...searchTags];
                if (searchInputValue.trim()) terms.push(searchInputValue.trim());

                // Vis hvis oppskriften inneholder MINST 칠n av taggene (OR-logic er ofte best for "t칮m kj칮leskapet")
                return terms.some(term => {
                    const q = term.toLowerCase();
                    return r.title.toLowerCase().includes(q) || r.ingredients.some(i => i.toLowerCase().includes(q));
                });
            });

            const toggleItem = (key) => {
                const newState = { ...checkedItems, [key]: !checkedItems[key] };
                setCheckedItems(newState);
                localStorage.setItem(`familienBro-handleliste-uke${currentWeek}`, JSON.stringify(newState));
            };

            const resetList = () => {
                if(confirm('Vil du nullstille listen for denne uken?')) {
                    setCheckedItems({});
                    localStorage.removeItem(`familienBro-handleliste-uke${currentWeek}`);
                }
            };

            const handleRecipeClick = (e, recipe) => {
                if (e) e.stopPropagation(); 
                if (recipe) {
                    setCurrentRecipe(recipe);
                    setRecipeServings(recipe.servings);
                    setCompletedSteps(new Set());
                    setActiveTab('recipe');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleRating = (stars) => {
                if (!currentRecipe) return;
                const newRatings = { ...ratings, [currentRecipe.title]: stars };
                setRatings(newRatings);
                localStorage.setItem('familienBro-ratings', JSON.stringify(newRatings));
            };

            const toggleStep = (index) => {
                const newSet = new Set(completedSteps);
                if (newSet.has(index)) newSet.delete(index);
                else newSet.add(index);
                setCompletedSteps(newSet);
            };

            const getScaledIngredient = (ing) => {
                const match = ing.match(/^([\d.,]+)/);
                if (match && currentRecipe) {
                    const originalVal = parseFloat(match[0].replace(',', '.'));
                    if (!isNaN(originalVal)) {
                        const scaledVal = (originalVal / currentRecipe.servings) * recipeServings;
                        const formatted = Number.isInteger(scaledVal) ? scaledVal : scaledVal.toFixed(1);
                        return ing.replace(match[0], formatted);
                    }
                }
                return ing;
            };

            const addTimer = (minutes, label) => {
                const newTimer = {
                    id: Date.now(),
                    label: label || "Timer",
                    timeRemaining: minutes * 60,
                    active: true,
                    finished: false,
                    acknowledged: false // New field for repeating alarm logic
                };
                setActiveTimers(prev => [...prev, newTimer]);
            };

            return (
                <div className="min-h-screen flex flex-col pb-20">
                    <header className="bg-lime-900 text-white shadow-lg sticky top-0 z-40 no-print">
                        <div className="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => setActiveTab('menu')}>
                                <Icon name="leaf" className="w-6 h-6 text-lime-300" />
                                <h1 className="text-xl font-bold tracking-tight hidden sm:block">Familien Bro</h1>
                            </div>
                            
                            {activeTab === 'menu' && (
                                <div className="flex bg-lime-950/50 rounded-lg p-1 mx-2">
                                    <button onClick={() => setCurrentWeek(1)} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${currentWeek === 1 ? 'bg-white text-lime-900 shadow' : 'text-lime-200 hover:text-white'}`}>Uke 1</button>
                                    <button onClick={() => setCurrentWeek(2)} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${currentWeek === 2 ? 'bg-white text-lime-900 shadow' : 'text-lime-200 hover:text-white'}`}>Uke 2</button>
                                </div>
                            )}

                            <nav className="hidden md:flex gap-1 bg-lime-950/30 p-1 rounded-lg">
                                {['menu', 'all_recipes', 'shopping', 'recipe'].map((tab) => (
                                    <button
                                        key={tab}
                                        onClick={() => setActiveTab(tab)}
                                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === tab ? 'bg-white text-lime-900 shadow-sm' : 'text-lime-100 hover:bg-lime-800'}`}
                                    >
                                        {tab === 'menu' && 'Meny'}
                                        {tab === 'all_recipes' && 'Oppskrifter'}
                                        {tab === 'shopping' && 'Liste'}
                                        {tab === 'recipe' && 'Visning'}
                                    </button>
                                ))}
                                <a href="trening.html" className="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-lime-100 hover:bg-lime-800 flex items-center gap-1">Trening</a>
                            </nav>

                            <button className="md:hidden p-2" onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>
                                <Icon name={mobileMenuOpen ? "x" : "menu"} className="w-6 h-6" />
                            </button>
                        </div>

                        {mobileMenuOpen && (
                            <div className="md:hidden bg-lime-900 border-t border-lime-700">
                                <div className="flex flex-col p-2 space-y-1">
                                    {['menu', 'all_recipes', 'shopping', 'recipe'].map((tab) => (
                                        <button key={tab} onClick={() => { setActiveTab(tab); setMobileMenuOpen(false); }} className={`px-4 py-3 rounded-md text-left font-medium ${activeTab === tab ? 'bg-lime-800 text-white' : 'text-lime-100'}`}>
                                            {tab === 'menu' && '游늰 Ukesmeny'}
                                            {tab === 'all_recipes' && '游 Alle Oppskrifter'}
                                            {tab === 'shopping' && '游 Handleliste'}
                                            {tab === 'recipe' && '游꼽 Visning'}
                                        </button>
                                    ))}
                                    <a href="trening.html" className="px-4 py-3 rounded-md text-left font-medium text-lime-100 hover:bg-lime-800">游눩 Trening</a>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-4xl mx-auto px-4 py-6 md:py-10 w-full flex-grow">
                        
                        <FloatingTimerList activeTimers={activeTimers} setActiveTimers={setActiveTimers} />

                        {activeTab === 'menu' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="text-center mb-8">
                                    <h2 className="text-3xl font-bold text-stone-800 mb-2">Ukesmeny - Uke {currentWeek}</h2>
                                    <p className="text-stone-600">Trykk p친 middag eller lunsj for 친 se oppskriften</p>
                                </div>

                                <div className="grid gap-6 md:grid-cols-1">
                                    {activeMenuData.map((day, idx) => (
                                        <div 
                                            key={idx} 
                                            onClick={(e) => handleRecipeClick(e, day.recipes.dinner)}
                                            className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden flex flex-col md:flex-row hover:shadow-lg transition-all cursor-pointer clickable-card group"
                                        >
                                            <div className="h-48 md:w-48 md:h-auto relative bg-stone-200 shrink-0">
                                                <img src={day.image} alt={day.dinner} className="w-full h-full object-cover transition-transform group-hover:scale-105 duration-500" />
                                                <div className="absolute top-0 left-0 bg-sky-700 text-white px-3 py-1 text-sm font-bold rounded-br-lg">
                                                    {day.day}
                                                </div>
                                            </div>
                                            <div className="p-6 flex-1 flex flex-col justify-center">
                                                <div className="flex items-center justify-between mb-3">
                                                    <div className="flex items-center gap-2">
                                                        <Icon name={day.iconName} className={`w-5 h-5 ${day.color}`} />
                                                        <span className="text-xs font-semibold uppercase tracking-wider text-stone-500 border border-stone-200 px-2 py-0.5 rounded-full">
                                                            {day.theme}
                                                        </span>
                                                    </div>
                                                    <div className="text-lime-700 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 text-xs font-medium">
                                                        Se middag <Icon name="chevron-right" className="w-4 h-4" />
                                                    </div>
                                                </div>
                                                <div className="space-y-3">
                                                    <div>
                                                        <h3 className="text-lg font-bold text-stone-800 leading-tight mb-1 group-hover:text-lime-800 transition-colors">{day.dinner}</h3>
                                                        <p className="text-sm text-stone-500 flex items-center gap-1"><Icon name="utensils-crossed" className="w-3 h-3" /> Middag</p>
                                                    </div>
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-3 border-t border-stone-100">
                                                        <div 
                                                            onClick={(e) => handleRecipeClick(e, day.recipes.lunchKid)}
                                                            className={`p-2 rounded-lg transition-colors border border-transparent ${day.recipes.lunchKid ? 'bg-orange-50 hover:bg-orange-100 hover:border-orange-200 cursor-pointer lunch-card' : 'bg-stone-50'}`}
                                                        >
                                                            <div className="flex justify-between items-start">
                                                                <p className="text-xs font-bold text-orange-800 uppercase mb-0.5">Lunsj Barn</p>
                                                                {day.recipes.lunchKid && <Icon name="arrow-up-right" className="w-3 h-3 text-orange-400" />}
                                                            </div>
                                                            <p className="text-sm text-stone-700 leading-snug">{day.lunchKid}</p>
                                                        </div>

                                                        <div 
                                                            onClick={(e) => handleRecipeClick(e, day.recipes.lunchAdult)}
                                                            className={`p-2 rounded-lg transition-colors border border-transparent ${day.recipes.lunchAdult ? 'bg-sky-50 hover:bg-sky-100 hover:border-sky-200 cursor-pointer lunch-card' : 'bg-stone-50 opacity-70'}`}
                                                        >
                                                            <div className="flex justify-between items-start">
                                                                <p className="text-xs font-bold text-sky-800 uppercase mb-0.5">Lunsj Voksen</p>
                                                                {day.recipes.lunchAdult && <Icon name="arrow-up-right" className="w-3 h-3 text-sky-400" />}
                                                            </div>
                                                            <p className="text-sm text-stone-700 leading-snug">{day.lunchAdult}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'all_recipes' && (
                            <div className="animate-fade-in">
                                <div className="text-center mb-8">
                                    <h2 className="text-3xl font-bold text-stone-800 mb-4">Alle Oppskrifter</h2>
                                    
                                    {/* TAG S칒K / T칒M KJ칒LESKAPET */}
                                    <div className="max-w-md mx-auto relative mb-6">
                                        <TagSearchInput 
                                            tags={searchTags} 
                                            setTags={setSearchTags}
                                            inputValue={searchInputValue}
                                            setInputValue={setSearchInputValue}
                                            placeholder="T칮m kj칮leskapet (skriv ingrediens, trykk enter...)"
                                        />
                                        <p className="text-xs text-stone-400 mt-2 text-center">
                                            Legg til ingredienser du har (f.eks "Egg", "Tomat"). Vi viser oppskrifter som inneholder minst 칠n av dem.
                                        </p>
                                    </div>
                                </div>

                                <div className="grid gap-6 grid-cols-1 md:grid-cols-2">
                                    {filteredAllRecipes.length === 0 && (
                                        <div className="text-center py-10 text-stone-500 col-span-full">
                                            Ingen oppskrifter funnet med disse ingrediensene 游볿
                                        </div>
                                    )}
                                    {filteredAllRecipes.map((recipe, idx) => (
                                        <div 
                                            key={idx} 
                                            onClick={() => handleRecipeClick(null, recipe)}
                                            className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden hover:shadow-lg transition-all cursor-pointer flex flex-col"
                                        >
                                            <div className="h-40 relative bg-stone-200">
                                                <img src={recipe.image} alt={recipe.title} className="w-full h-full object-cover" />
                                                <div className="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-xs font-bold text-stone-700">
                                                    Uke {recipe.week}  {recipe.day}
                                                </div>
                                            </div>
                                            <div className="p-4 flex-grow flex flex-col justify-between">
                                                <div>
                                                    <span className="text-xs font-bold text-lime-600 uppercase mb-1 block">{recipe.type}</span>
                                                    <h3 className="font-bold text-stone-800 text-lg leading-tight mb-2">{recipe.title}</h3>
                                                    <p className="text-sm text-stone-500 line-clamp-2">{recipe.desc}</p>
                                                </div>
                                                <div className="mt-4 flex items-center gap-4 text-xs text-stone-400">
                                                    <div className="flex items-center gap-1"><Icon name="clock" className="w-3 h-3" /> {recipe.time}</div>
                                                    {ratings[recipe.title] && (
                                                        <div className="flex items-center gap-1 text-yellow-500"><Icon name="star" className="w-3 h-3 fill-current" /> {ratings[recipe.title]}</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'shopping' && (
                            <div className="max-w-2xl mx-auto animate-fade-in">
                                <div className="flex items-center justify-between mb-6 no-print">
                                    <h2 className="text-3xl font-bold text-stone-800">Handleliste (Uke {currentWeek})</h2>
                                    <div className="flex gap-3">
                                        <button onClick={() => window.print()} className="text-sm text-lime-700 hover:text-lime-900 font-medium flex items-center gap-1">
                                            <Icon name="printer" className="w-4 h-4 inline" /> Skriv ut
                                        </button>
                                        <button onClick={resetList} className="text-sm text-lime-700 hover:text-lime-900 font-medium">
                                            Nullstill
                                        </button>
                                    </div>
                                </div>

                                <div className="grid gap-6">
                                    {Object.entries(activeShoppingList).map(([category, items]) => (
                                        <div key={category} className="bg-white rounded-xl shadow-sm border border-stone-200 p-6 break-inside-avoid">
                                            <h3 className="text-lg font-bold text-lime-800 border-b border-lime-100 pb-2 mb-4">
                                                {category}
                                            </h3>
                                            <div className="space-y-3">
                                                {items.map((item, idx) => {
                                                    const key = `${category}-${idx}`;
                                                    const isChecked = checkedItems[key];
                                                    return (
                                                        <div 
                                                            key={key} 
                                                            onClick={() => toggleItem(key)}
                                                            className="flex items-start gap-3 cursor-pointer group select-none"
                                                        >
                                                            <div className={`mt-0.5 shrink-0 transition-colors ${isChecked ? 'text-lime-600' : 'text-stone-300 group-hover:text-lime-400'}`}>
                                                                <Icon name={isChecked ? "check-circle-2" : "circle"} className="w-5 h-5" />
                                                            </div>
                                                            <span className={`text-base transition-all ${isChecked ? 'text-stone-400 line-through decoration-stone-300' : 'text-stone-700'}`}>
                                                                {item}
                                                            </span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'recipe' && currentRecipe && (
                            <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg border border-stone-100 overflow-hidden animate-fade-in">
                                <div className="h-64 relative bg-stone-800">
                                    <img src={currentRecipe.image} alt={currentRecipe.title} className="w-full h-full object-cover opacity-90" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex items-end">
                                        <div className="p-8 text-white w-full">
                                            <div className="flex justify-between items-end">
                                                <div>
                                                    <h2 className="text-3xl font-bold mb-2">{currentRecipe.title}</h2>
                                                    <p className="text-lg text-lime-200">{currentRecipe.desc}</p>
                                                </div>
                                                
                                                <div className="flex flex-col items-end">
                                                    <div className="flex gap-1">
                                                        {[1,2,3,4,5].map(star => (
                                                            <button 
                                                                key={star} 
                                                                onClick={(e) => {e.stopPropagation(); handleRating(star)}}
                                                                className={`transition-transform hover:scale-125 ${ratings[currentRecipe.title] >= star ? 'text-yellow-400 fill-yellow-400' : 'text-white/50'}`}
                                                            >
                                                                <Icon name="star" className="w-6 h-6" />
                                                            </button>
                                                        ))}
                                                    </div>
                                                    <span className="text-xs text-lime-100 mt-1 uppercase tracking-widest">Matdommer</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="p-8">
                                    <div className="flex flex-wrap items-center justify-between gap-6 mb-6 text-sm text-stone-500 border-b border-stone-100 pb-6">
                                        <div className="flex gap-6">
                                            <div className="flex items-center gap-2"><Icon name="chef-hat" className="text-lime-600 w-5 h-5" /><span>Enkel</span></div>
                                            <div className="flex items-center gap-2"><Icon name="coffee" className="text-lime-600 w-5 h-5" /><span>{currentRecipe.time}</span></div>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {currentRecipe.timers && currentRecipe.timers.map((timer, i) => (
                                                <button 
                                                    key={i}
                                                    onClick={() => addTimer(timer.minutes, timer.label)}
                                                    className="flex items-center gap-2 bg-stone-100 hover:bg-stone-200 px-3 py-1.5 rounded-full text-stone-700 transition-colors font-medium text-xs"
                                                >
                                                    <Icon name="timer" className="w-4 h-4" /> {timer.label} ({timer.minutes} min)
                                                </button>
                                            ))}
                                            {(!currentRecipe.timers || currentRecipe.timers.length === 0) && (
                                                <button 
                                                    onClick={() => addTimer(10, "Timer")}
                                                    className="flex items-center gap-2 bg-stone-100 hover:bg-stone-200 px-3 py-1.5 rounded-full text-stone-700 transition-colors font-medium text-xs"
                                                >
                                                    <Icon name="timer" className="w-4 h-4" /> Start timer (10 min)
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    {currentRecipe.nutrition && (
                                        <div className="bg-orange-50 rounded-xl p-4 mb-8 border border-orange-100">
                                            <h4 className="text-xs font-bold text-orange-800 uppercase tracking-wider mb-3">N칝ringsinnhold pr. porsjon (ca.)</h4>
                                            <div className="grid grid-cols-4 gap-2 text-center">
                                                <div className="bg-white p-2 rounded-lg shadow-sm">
                                                    <div className="text-lg font-bold text-stone-800">{currentRecipe.nutrition.calories}</div>
                                                    <div className="text-[10px] text-stone-500 uppercase">kcal</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg shadow-sm">
                                                    <div className="text-lg font-bold text-stone-800">{currentRecipe.nutrition.protein}</div>
                                                    <div className="text-[10px] text-stone-500 uppercase">Protein</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg shadow-sm">
                                                    <div className="text-lg font-bold text-stone-800">{currentRecipe.nutrition.fat}</div>
                                                    <div className="text-[10px] text-stone-500 uppercase">Fett</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg shadow-sm">
                                                    <div className="text-lg font-bold text-stone-800">{currentRecipe.nutrition.carbs}</div>
                                                    <div className="text-[10px] text-stone-500 uppercase">Karb.</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="grid md:grid-cols-2 gap-10">
                                        <div>
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="font-bold text-stone-800 text-lg flex items-center gap-2">
                                                    <span className="bg-lime-100 text-lime-800 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                                                    Ingredienser
                                                </h3>
                                                <div className="flex items-center gap-3 bg-stone-100 px-3 py-1 rounded-full">
                                                    <button onClick={() => setRecipeServings(Math.max(1, recipeServings - 1))} className="text-stone-500 hover:text-stone-800"><Icon name="minus" className="w-4 h-4" /></button>
                                                    <span className="text-sm font-bold text-stone-800 w-4 text-center">{recipeServings}</span>
                                                    <button onClick={() => setRecipeServings(recipeServings + 1)} className="text-stone-500 hover:text-stone-800"><Icon name="plus" className="w-4 h-4" /></button>
                                                    <span className="text-xs text-stone-500 ml-1">porsjoner</span>
                                                </div>
                                            </div>
                                            <ul className="space-y-2 text-stone-700">
                                                {currentRecipe.ingredients.map((ing, i) => (
                                                    <li key={i} className="flex items-start gap-2 p-2 rounded-lg hover:bg-stone-50 transition-colors">
                                                        <span className="w-1.5 h-1.5 bg-lime-400 rounded-full mt-2 shrink-0"></span>
                                                        <span>{getScaledIngredient(ing)}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>

                                        <div>
                                            <h3 className="font-bold text-stone-800 text-lg mb-4 flex items-center gap-2">
                                                <span className="bg-lime-100 text-lime-800 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                                                Fremgangsm친te
                                            </h3>
                                            <ol className="space-y-4">
                                                {currentRecipe.steps.map((step, i) => (
                                                    <li 
                                                        key={i} 
                                                        onClick={() => toggleStep(i)}
                                                        className={`flex gap-4 p-3 rounded-xl cursor-pointer transition-all border ${completedSteps.has(i) ? 'bg-stone-50 border-stone-200 step-checked' : 'bg-white border-transparent hover:border-lime-100 hover:shadow-sm'}`}
                                                    >
                                                        <div className={`mt-0.5 shrink-0 ${completedSteps.has(i) ? 'text-lime-500' : 'text-lime-700'}`}>
                                                            {completedSteps.has(i) ? <Icon name="check-circle-2" className="w-6 h-6" /> : <span className="font-bold text-lg font-mono">{i + 1}.</span>}
                                                        </div>
                                                        <p>{step}</p>
                                                    </li>
                                                ))}
                                            </ol>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-8 bg-sky-50 p-4 rounded-lg border border-sky-100">
                                        <h4 className="font-bold text-sky-800 mb-1 text-sm">游눠 Tips fra Familien Bro</h4>
                                        <p className="text-sky-700 text-sm">
                                            Trykk p친 stegene over n친r du er ferdig med dem for 친 holde oversikten!
                                        </p>
                                    </div>

                                    <div className="mt-6 pt-6 border-t border-stone-100 text-center md:hidden">
                                        <button 
                                            onClick={() => setActiveTab('menu')}
                                            className="text-lime-700 font-medium hover:text-lime-900 text-sm flex items-center justify-center gap-2 w-full p-2"
                                        >
                                            <Icon name="arrow-left" className="w-4 h-4" /> Tilbake til menyen
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="bg-stone-800 text-stone-400 py-8 mt-12 text-center text-sm no-print">
                        <p>Familien Bro - Ukesmeny</p>
                        <p className="mt-1">Basert p친 middelhavsdietten 游꺔</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>